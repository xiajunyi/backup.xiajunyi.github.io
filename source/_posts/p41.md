---
title: Github的webhook触发vps上的脚本
id: 411
categories:
  - linux
date: 2018/5/23 17:04:15     
tags: [github, webhook]
toc: true
---

一直想测试一下github上的webhook的用法，今天利用webhook实现将部署在github上的hexo网站资源同步到vps上。关于nginx、hexo、travis_ci配置及git的基础配置这里就不累述了，下面讲一下原理及webhook相关的主要代码和配置。

<!--more-->

## 环境
+ VPS端(CENTOS6):NodeJs、Git
+ WINDOWS端：Git
+ GitHub
+ Travis_Ci


## 原理
原理主要是利用webhook推送http消息到vps端，然后vps端利用nodejs程序监听http消息，最后调用脚本执行git pull相关操作。具体流程如图所示：<br/>
![img](/img/xjy/webhook001.jpg)

## webhook配置
github端webhook主要配置的就是推送的地址，下面是我的配置:  <br/>
![img](/img/xjy/webhook002.jpg)

## vps端代码及配置
+ **nodejs代码:**下面是vps端nodejs的代码hexoHook.js。
``` py
var http = require('http');

http.createServer(function (request, response) {
    response.writeHead(200, {'Content-Type': 'text/plain'});
    response.end('Hi! xiajunyi\'s nodeJs Sever is Ok!\n');
	//开始准备调用脚本
	var callfile = require('child_process');
	callfile.execFile('/opt/gitCode/hexoHook.sh',null,null,function (err, stdout, stderr) {
     if (stderr) {
       console.log(stderr);
     }
     console.log(stdout);
 });
}).listen(8888);
```

+ **sh脚本:**下面是vps端被nodejs调用的sh脚本。
``` shell
cd /opt/gitCode/xiajunyi.github.io
git fetch --all
git reset --hard origin/master
git pull origin master
```

+ **执行监听程序：**真实服务的时候记得把该程序hexoHook.js加入开机启动项，下面是监听到的变动。
``` shell
[root@zyshops nodeTest]# node hexoHook.js 
Server running at http://127.0.0.1:8888/
From https://github.com/xiajunyi/xiajunyi.github.io
 + 641d46e...b41a89d master     -> origin/master  (forced update)
From https://github.com/xiajunyi/xiajunyi.github.io
 * branch            master     -> FETCH_HEAD

Fetching origin
HEAD is now at b41a89d docs:update articles
Already up-to-date.
```

## 效果
当访问[http://hexo.xiajunyi.com/pages/p41.html#more](http://hexo.xiajunyi.com/pages/p41.html#more)看到这篇文章时,说明vps端已经同步到了最新的资源。