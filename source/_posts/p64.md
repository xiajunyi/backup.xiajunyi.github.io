---
title: 动手搭建家庭NAS服务中心
id: 682
categories:
  - NAS
  - KODI
  - FRP
  - IPV6
  - TinyMediaManager
  - 黑群晖
  - 内网穿透
date: 2019/12/31 21:58:55        
tags: [NAS, 黑群晖, KODI]
toc: true
declare: true
---

![img](/img/xjy/p64000.png)<br/>

## 前言

2019马上就结束了，回顾这一年，有收获也有失去。收获是在工作遇到的新知识方面，整体有提升；不顺利的是身体方面，膝盖软骨损伤，以后就打不成球了，可悲啊！在目前养病的这段时间中，我想最近可以做啥有意思的新东西？目标不能定太大，就先为家里做点小事开始吧！心动不如行动，我开始盯上了个人NAS。原因很简单：我已经厌倦了百度云盘的龟速下载，之前的破解加速方式也一直在变，当然我肯定不会开一年300多块的所谓超级VIP，于是乎我的想法就延伸开来，标题中的图就是我想实现的功能。
<!--more-->

## 简介
本篇文章先讲NAS硬件到软件的选型，接着从远程下载、家庭KTV、影视中心、远程文件同步四个方面讲了如何结合群辉系统来实现。个人觉得主要难点在于如何实现外网访问，群辉虽提供quick connect的外网访问服务，淘宝上也有黑群晖洗白的账号购买，但盗亦有道（其实我还是觉得自己实现的扩展性更强），我就不占用官方资源了。文章中间穿插的环节对FRP内网穿透和IPV6+FTP两种外网访问方式进行了关键点的介绍，具体的详细操作也会提供参考文章，感兴趣的小伙伴可以动起手啦！

## 选型
### 硬件选型
想要实现图中的功能，首先我得有硬件，对比了网上无数种方案，最稳定最完美的当属正版的群辉主机，然而囊中羞涩的我还是选择了价格最低的这种号称性价比极致的：星际蜗牛矿渣，有四盘位，另加固态硬盘，总价才不到500。还需要买的当然是硬盘了，推荐西数的红盘和希捷的酷狼，这两种硬盘专门为NAS设计的。一切的一切都是围绕着硬盘中的数据来的，所以后面考虑长期运行的稳定性，需要买个UPS的电源，价格大概两百多，贵虽贵点，但是数据无价。
![img](/img/xjy/p64001.png)<br/>


### 系统选型
淘宝买来主机后，店主已经预装了黑群晖6.2.2版本，由于群辉系统的稳定和可玩性很高，同时是基于linux系统，那么我就不考虑改装WIN10去挑战这廉价硬件的性能底线了。
![img](/img/xjy/p64002.png)<br/>

## 基础设置
群辉的基础设置网上讲的太多了，最权威的当属于它的[官网](https://www.synology.cn/zh-cn/support)（也欢迎不差钱的小伙伴去购买正版的群辉软硬件），我这里只讲一下大致流程。
### 挂载新硬盘
如果是重要数据，建议挂载硬盘时把两块盘选择RAID类型，这种虽然有一块只能当备份盘，但至少能保证数据的可恢复性更大。
![img](/img/xjy/p64003.png)<br/>
### 新建共享文档和用户
接下来要做的就是新建共享文档和用户，并指定文档权限。
![img](/img/xjy/p64004.png)<br/>
### 开通NFS和SMB
下面是局域网开通NFS和SMB服务协议
![img](/img/xjy/p64005.png)<br/>
至此，可以在局域网中访问到共享的文件夹了。

## 远程下载
实现远程下载需要解决两个问题，一是安装合适的下载软件，还有就是实现远程的管理访问。

### 安装下载软件
想要安装下载的软件很简单，在群辉的套件中心中可以安装Download Station（群辉自带）、万物下载（集成了迅雷）、Transmission等软件后即可点击访问。值得一提的是，现在很多网上的种子或磁力链接下载速度慢或者没有速度，可以考虑添加git上共享的最新的[Tracker服务地址](https://github.com/ngosang/trackerslist)进行下载。
![img](/img/xjy/p64016.png)<br/>
### 实现远程管理
其实，这里需要解决的最大问题在于如何外网访问我们的群辉管理界面，我这里采用的是FRP方式访问，这个网上的[FRP配置教程](https://m.baidu.com/ala/c/www.360doc.cn/mip/832615435.html)也很多,我讲一下我的大致流程。
+ 在VPS上安装FRP服务端，配置frps.ini，并配置开机启动
+ 在群辉上安装Docker套件，配置frpc.ini，并运行FRP客户端容器（记得指定frpc.ini配置文件的位置），我这里的镜像名为：oldiy-frpc
+ 如需HTTPS访问，还需在群辉中导入证书
+ 映射域名到VPS上配置的对应端口
+ 接下来就可以在浏览器中用域名访问了
![img](/img/xjy/p64006.png)<br/>

## 家庭KTV
实现家庭KTV需要解决的是歌曲资源，还有就是点歌。这部分我的资源都来自淘宝，没有什么技术含量，简单提一下。

### 下载曲目
我是在淘宝上花几块钱买了几十T的最新歌库资源，可以按照自己喜欢的歌手或者曲名搜索下载到我的NAS对应的文件夹中。这里不必做广告，淘宝上评价最好的那一家就是，非常便宜。

### 点歌软件
淘宝店家送的免费软件，提供添加歌库和点歌的功能，可惜只支持windows系统，正好我有个闲置的WIN10平板，借助WIFI局域网连上NAS的共享文件夹，通过HDMI连接到家里的智能电视即可实现触屏点歌了。
![img](/img/xjy/p64007.png)<br/>


## 影院中心
这部分看起来也是文件的共享和播放，但其实没那么简单。因为点歌只在家里使用，可以连接局域网，但想要实现远程看NAS上的高清电影、电视剧，就需要保证远程播放的速度，那么FRP这种方式就有它的弊端了。为什么会这样说呢？因为我的FRP服务用的是阿里云的VPS，带宽只有1Mbps，那么换算下来，只能提供不到200KB/s的播放速度，因此，这种方案不适合我这种穷人。后来通过查资料和尝试，成功用IPV6+FTP的方式实现了远程高速播放。下面都讲一下吧。

### 远程访问方式一：FRP+FTP
之前没有意识到我的阿里云服务器只有1Mbps的带宽，就用了这种方式。当然，如果你有大带宽的VPS服务，且你本地的服务运营商没有给你提供IPV6服务的时候，推荐你使用这种方式。
+ 开启群晖FTP服务，映射21端口和被动模式下的随机端口
![img](/img/xjy/p64010.png)<br/>
+ FRP客户端配置frpc.ini中增加21端口和随机区间接口（注意：映射的区间端口个数要一致）的映射
``` text
[range:ftp]
type = tcp
local_ip = 127.0.0.1
local_port = 21,55536-55636
remote_port = 2121,55536-55636
```
+ FRP服务端不用做修改，记得阿里云安全组里把这一系列端口开放出去就可以用FTP客户端访问啦！
![img](/img/xjy/p64008.png)<br/>

### 远程访问方式二：IPV6+FTP方式（推荐）
上面方案不适合我的原因已经说了，本来我想是否买一个带宽大一点的VPS，后来还好想了想这总归不能从根本上解决问题，就没有这样做。我测试了一下本地的移动宽带网络，发现上传速率能稳定在20~30Mbps左右，这速率本身用来提供播放时的FTP上传已经够用了。那下面就是想办法把它直接开放出去，当然IPV4不用想了，移动运营商是不会给公网IP的，于是我就在网上找到了这篇[利用IPV6+自定义脚本DDNS访问群晖](https://post.smzdm.com/p/aqndw6op/)的文章，写的很详细，这里给作者点赞，推荐大家参考。我这里讲一下主要实现步骤。
+ 域名添加AAAA类型的解析，解析到群晖的IPV6地址（因为这个地址会被更新，暂时先设一个）。
![img](/img/xjy/p64011.png)<br/>
+ 申请阿里云的管理AccessKey
+ 群晖添加定时计划，将申请到的Key等信息填入脚本,后面该脚本每十分钟会执行一次，将最新的IPV6地址更新到域名解析中
![img](/img/xjy/p64012.png)<br/>
+ 接着就是测试效果了，我分别用我的手机移动和联通卡建立热点，给电视盒子连接，在播放4GB左右大小的电影的时候，基本毫无压力
![img](/img/xjy/p64018.png)<br/>

### KODI的使用
KODI最初听说以为它只是一款视频播放器，但其实的它的功能很强大。它可以安装在Windows、Android、IOS、MAC等多种平台上，提供点播、直播、字幕下载、信息搜刮、海报墙展示、分用户权限登录等多种功能，还支持NFS、SMB、FTP等多种网络文件的传输连接，最重要的是它是一款开源软件，具有丰富的插件库，能够提供更多影视、音乐以及游戏资源的扩展。  
说了这么多，我目前主要用它还是播放NAS上的影视资源，这里有一个视频讲解和大家分享：[手把手教你组建家庭影院！（KODI+群晖+智能电视）](https://www.bilibili.com/video/av55317890/?spm_id_from=333.788.videocard.10),别人讲的很详细，我这里也还是大致步骤：
+ 手机、平板或者电视盒子上安装KODI软件，注意有的安卓系统版本太低可能不支持最新的KODI
+ 到Interface中设置中文界面
+ 可以添加用到的中文插件库，安装例如豆瓣搜刮器等插件
+ 添加NAS上的文件映射连接作为视频源，局域网选择SMB或NFS的方式，远程选择FTP的方式（可以添加多个视频源）
+ 选择视频类型（电影或者电视等）后，更新资料库
+ 选择你喜欢的海报墙列表，接下来享受你的高清影院吧
![img](/img/xjy/p64013.png)<br/>

>PS：这里还有两点可以讲一下，一是搜刮器，二是直播源。搜刮器方面，自动搜刮器插件虽好，但无法避免搜刮的信息不全的现象，这里推荐有精力且喜欢收藏的小伙伴在自己的电脑上安装TinyMediaManager这款软件，为自己喜欢的精品影视资源搜刮并编辑影视海报、简介、预告等信息，这里分享一个讲解视频：[超完美整理家庭影音资料库，完美适配Kodi, Emby, Jellyfin, Plex等家庭影音软件](https://www.bilibili.com/video/av73683523/?spm_id_from=333.788.videocard.1)；直播源方面，如果你想看直播，那么只需安装IPTV Simple Client插件，在直播channel中设置上从网上分享来的各种直播源即可。这里分享一个视频讲解教程：[【KODI应该这么玩】之IPTV篇（小白）](https://www.bilibili.com/video/av68389816/?spm_id_from=333.788.videocard.8)。


## 远程文件同步
远程文件同步适合办公和提供类似共享网盘的功能。

### 服务端安装
服务端在群辉套件中安装SynologyDrive Server即可。
![img](/img/xjy/p64014.png)<br/>

### 客户端安装
客户端在群辉官网下载安装SynologyDrive Client，登录进入后设置本地同步文件夹对应的本地目录，以后随时随地都可以双向同步文件了。手机端也可安装app，这里就不累述了。
![img](/img/xjy/p64015.png)<br/>

## 结束语
群辉还提供了相关的DS Video、DS photo、DS File等手机APP，这些比较简单，这里就不一一罗列了。好玩的东西后面还有很多，目前实现的功能细节虽不能做到详述，但关键步骤已经都在里面了。群辉玩的差不多后，准备尝试玩一下Free Nas系统，虽然Free Nas的生态链还没有群辉那么完全，但它是开源的（我喜欢纯净的感觉）。生命在于折腾，我还未放弃折腾，有时间继续搞的话，下期再见！
